// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider               = "prisma-client-js"
  output                 = "../../shared/generated/prisma-client"
  moduleFormat           = "esm"
  generatedFileExtension = ".ts"
  importFileExtension    = ".ts"
}

datasource db {
  provider = "postgresql"
}

enum GuildType {
  ACT
  VENUE
  CLUB
}

enum GuildInvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELLED
}

enum FollowEntityType {
  USER
  TAG
  GUILD
}

enum TrackType {
  SONG
  OTHER
}

enum SharePermission {
  VIEW_ONLY
  CAN_EDIT
}

model User {
  userId      String   @id @default(cuid())
  email       String   @unique
  displayName String?
  avatar      String?
  firebaseUid String?  @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  createdGuilds  Guild[] @relation("GuildCreator")
  ownedGuilds    Guild[] @relation("GuildOwner")
  memberOfGuilds Guild[] @relation("GuildMembers")

  follows    Follow[]
  followedBy Follow[] @relation("UserFollows")

  feedActivities FeedActivity[]

  sentInvitations     GuildInvitation[] @relation("SentInvitations")
  receivedInvitations GuildInvitation[] @relation("ReceivedInvitations")

  ownedSetLists SetList[]      @relation("SetListOwner")
  createdShares SetListShare[] @relation("ShareCreator")
}

model Follow {
  followId String @id @default(cuid())
  userId   String
  user     User   @relation(fields: [userId], references: [userId])

  entityType FollowEntityType

  // Exactly one of these should be set based on entityType
  followedUserId String?
  followedUser   User?   @relation("UserFollows", fields: [followedUserId], references: [userId])

  tagId String?
  tag   Tag?    @relation(fields: [tagId], references: [tagId])

  guildId String?
  guild   Guild?  @relation(fields: [guildId], references: [guildId])

  createdAt DateTime @default(now())

  @@unique([userId, entityType, followedUserId, tagId, guildId])
  @@index([userId])
  @@index([followedUserId])
  @@index([tagId])
  @@index([guildId])
}

model Tag {
  tagId    String   @id @default(cuid())
  category String
  value    String
  follows  Follow[]
  tracks   Track[]  @relation("TrackTags")

  @@unique([category, value])
}

model Guild {
  guildId        String    @id @default(cuid())
  name           String
  guildType      GuildType
  createdAt      DateTime  @default(now())
  createdById    String?
  createdBy      User?     @relation("GuildCreator", fields: [createdById], references: [userId])
  currentOwnerId String
  currentOwner   User      @relation("GuildOwner", fields: [currentOwnerId], references: [userId])
  members        User[]    @relation("GuildMembers")

  // Explicit foreign keys (exactly one should be set based on guildType)
  actId   String? @unique
  act     Act?    @relation(fields: [actId], references: [actId])
  venueId String? @unique
  venue   Venue?  @relation(fields: [venueId], references: [venueId])
  clubId  String? @unique
  club    Club?   @relation(fields: [clubId], references: [clubId])

  follows     Follow[]
  invitations GuildInvitation[]
  setLists    SetList[]
}

model Act {
  actId     String   @id @default(cuid())
  name      String
  bio       String?
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  guild          Guild?
  calendarEvents CalendarEvent[]
}

model Venue {
  venueId   String   @id @default(cuid())
  name      String
  address   String?
  city      String?
  state     String?
  zipCode   String?
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  guild          Guild?
  calendarEvents CalendarEvent[]
}

model Club {
  clubId      String   @id @default(cuid())
  name        String
  description String?
  avatar      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  guild Guild?
}

model Track {
  trackId         String    @id @default(cuid())
  type            TrackType @default(SONG)
  title           String
  artist          String
  defaultDuration Int?
  defaultTuning   String?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  createdBy       String

  tags     Tag[]     @relation("TrackTags")
  setItems SetItem[]

  @@index([title])
  @@index([artist])
  @@index([type])
  @@index([isActive])
  @@index([createdBy])
}

model CalendarEvent {
  eventId     String   @id @default(cuid())
  title       String?
  description String?
  poster      String? // Event poster/flyer image
  startTime   DateTime
  duration    Int // In minutes
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  venueId String
  venue   Venue  @relation(fields: [venueId], references: [venueId])

  acts           Act[]
  feedActivities FeedActivity[]
}

model FeedActivity {
  activityId   String   @id @default(cuid())
  activityType String // e.g., "event_created", "event_updated"
  createdAt    DateTime @default(now())

  // Polymorphic reference to the subject of the activity
  subjectType String // "CalendarEvent", "User", etc.
  subjectId   String

  // Optional reference to calendar event if this is event-related
  calendarEventId String?
  calendarEvent   CalendarEvent? @relation(fields: [calendarEventId], references: [eventId])

  // Optional reference to user who triggered the activity
  userId String?
  user   User?   @relation(fields: [userId], references: [userId])

  @@index([createdAt])
  @@index([subjectType, subjectId])
}

model GuildInvitation {
  invitationId String @id @default(cuid())
  guildId      String
  guild        Guild  @relation(fields: [guildId], references: [guildId])

  invitedUserId String
  invitedUser   User   @relation("ReceivedInvitations", fields: [invitedUserId], references: [userId])

  invitedById String?
  invitedBy   User?   @relation("SentInvitations", fields: [invitedById], references: [userId])

  status      GuildInvitationStatus @default(PENDING)
  createdAt   DateTime              @default(now())
  respondedAt DateTime?

  @@unique([guildId, invitedUserId])
  @@index([invitedUserId, status])
  @@index([guildId, status])
}

model SetList {
  setListId   String   @id @default(cuid())
  name        String
  description String?
  ownerId     String
  owner       User     @relation("SetListOwner", fields: [ownerId], references: [userId], onDelete: Cascade)
  guildId     String?
  guild       Guild?   @relation(fields: [guildId], references: [guildId], onDelete: Cascade)
  isPrivate   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  setItems    SetItem[]
  setSections SetSection[]
  shares      SetListShare[]

  @@index([ownerId])
  @@index([guildId])
  @@index([isPrivate])
}

model SetItem {
  setItemId      String      @id @default(cuid())
  setListId      String
  setList        SetList     @relation(fields: [setListId], references: [setListId], onDelete: Cascade)
  trackId        String
  track          Track       @relation(fields: [trackId], references: [trackId], onDelete: Restrict)
  position       Int
  customTuning   String?
  customNotes    String?
  customDuration Int?
  sectionId      String?
  section        SetSection? @relation(fields: [sectionId], references: [sectionId], onDelete: SetNull)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@unique([setListId, position])
  @@index([setListId])
  @@index([trackId])
  @@index([sectionId])
}

model SetSection {
  sectionId     String   @id @default(cuid())
  setListId     String
  setList       SetList  @relation(fields: [setListId], references: [setListId], onDelete: Cascade)
  name          String
  position      Int
  breakDuration Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  setItems SetItem[]

  @@unique([setListId, position])
  @@index([setListId])
}

model SetListShare {
  shareId    String          @id @default(cuid())
  setListId  String
  setList    SetList         @relation(fields: [setListId], references: [setListId], onDelete: Cascade)
  shareToken String          @unique
  permission SharePermission @default(VIEW_ONLY)
  expiresAt  DateTime?
  createdAt  DateTime        @default(now())
  createdBy  String
  creator    User            @relation("ShareCreator", fields: [createdBy], references: [userId])

  @@index([setListId])
  @@index([shareToken])
  @@index([expiresAt])
}
